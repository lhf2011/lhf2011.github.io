<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multi-sensor fusion | Gridea</title>
<link rel="shortcut icon" href="https://lhf2011.github.io/favicon.ico?v=1603665293216">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://lhf2011.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Multi-sensor fusion | Gridea - Atom Feed" href="https://lhf2011.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="1, CalcRelateValue
1.1 For Mobileye, Velodyne and surround-view-cameras
double PosXscore = PercentScore( DeltaPosX, Delt..." />
    <meta name="keywords" content="Correlation Matrix,DS,Hungarian algorithm,Auction Algorithm" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://lhf2011.github.io">
  <img class="avatar" src="https://lhf2011.github.io/images/avatar.png?v=1603665293216" alt="">
  </a>
  <h1 class="site-title">
    Gridea
  </h1>
  <p class="site-description">
    Be good. 
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Index
        </a>
      
    
      
        <a href="/archives" class="menu">
          Archives
        </a>
      
    
      
        <a href="/tags" class="menu">
          Tags
        </a>
      
    
      
        <a href="/post/about" class="menu">
          About
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Multi-sensor fusion
            </h2>
            <div class="post-info">
              <span>
                2020-09-17
              </span>
              <span>
                8 min read
              </span>
              
                <a href="https://lhf2011.github.io/tag/JRiHO5gZy7/" class="post-tag">
                  # Correlation Matrix
                </a>
              
                <a href="https://lhf2011.github.io/tag/u2636m31du/" class="post-tag">
                  # DS
                </a>
              
                <a href="https://lhf2011.github.io/tag/cjVtALkhWz/" class="post-tag">
                  # Hungarian algorithm
                </a>
              
                <a href="https://lhf2011.github.io/tag/PKUO1g0HHL/" class="post-tag">
                  # Auction Algorithm
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="1-calcrelatevalue">1, CalcRelateValue</h1>
<h3 id="11-for-mobileye-velodyne-and-surround-view-cameras">1.1 For Mobileye, Velodyne and surround-view-cameras</h3>
<pre><code class="language-c++">double PosXscore = PercentScore( DeltaPosX, DeltaPosX_TH );
double PosYscore = PercentScore( DeltaPosY, DeltaPosY_TH );
double VelXscore = PercentScore( DeltaVelX, DeltaVelX_TH );
double VelYscore = PercentScore( DeltaVelY, DeltaVelY_TH );
double Widtscore = PercentScore( DeltaWidt, DeltaWidt_TH );
if( m_gstTrkSta[MobileyeTracked].bTracked )
    double Total = PosXscore * 0.2f + PosYscore * 0.4f + VelXscore * 0.1f + VelYscore * 0.1f +Widtscore * 0.2f;
else
    double Total = PosXscore * 0.2 + PosYscore * 0.4 + VelXscore * 0.2 + VelYscore * 0.2;
return      Total;
</code></pre>
<h3 id="12-for-mwr">1.2 For MWR</h3>
<p>MWR do not measure width</p>
<pre><code class="language-c++">double DeltaPosX = fabs( SimMeasurement( PosX_CORR ) - object.fRelX );
double DeltaPosY = fabs( SimMeasurement( PosY_CORR ) - object.fRelY );
double DeltaVelX = fabs( SimMeasurement( VelX_CORR ) - object.fAblVelX );
double DeltaVelY = fabs( SimMeasurement( VelY_CORR ) - object.fAblVelY );
double Total = PosXscore * 0.3 + PosYscore * 0.1 + VelXscore * 0.4 + VelYscore * 0.2;
return      Total;
</code></pre>
<h3 id="13-for-hdmap">1.3 For HDmap</h3>
<p>HDmap do not measure moving objects, only has x &amp; y</p>
<pre><code class="language-c++">double DeltaPosX = fabs( SimMeasurement( PosX_CORR ) - object.fRelX );
double DeltaPosY = fabs( SimMeasurement( PosY_CORR ) - object.fRelY );
double Total = PosXscore * 0.6 + PosYscore * 0.4;
return      Total;
</code></pre>
<h1 id="2-calculate-correlation-matrix">2, Calculate Correlation Matrix</h1>
<pre><code class="language-c++">//o for object, t for tracker;
m_pstCorrelationMatrix-&gt;pfCorrelationValue[o][t].fValue =  m_vecTrackers.data()[t].CalcRelateValue(SimMeasurement, m_pstSensorObjects-&gt;data()[o], Transform );
if ( m_pstCorrelationMatrix-&gt;pfCorrelationValue[o][t].fValue &gt; 0.0001f)
{
    m_pstCorrelationMatrix-&gt;pfCorrelationValue[o][t].fValue = m_pstCorrelationMatrix-&gt;pfCorrelationValue[o][t].fValue *0.98f + GetCorrelationPriority( m_vecTrackers.data() [t], m_pstSensorObjects-&gt;data()[o] );
} 
else
{
    m_pstCorrelationMatrix-&gt;pfCorrelationValue[o][t].fValue = 0.0f;
}
</code></pre>
<pre><code class="language-c++">GetCorrelationPriority
1, tracked by the same sensor and the same objectID-&gt;the highest priority
2, tracked by the same sensor but not the same objectID-&gt;high priority
3, tracked by another sensor-&gt;mid priority
4, a new detection, not tracked before-&gt;low priority
</code></pre>
<h1 id="3-getmaximumassociationvalue">3, GetMaximumAssociationValue</h1>
<h3 id="31-nearest-neighbor-algorithm">3.1 Nearest Neighbor Algorithm</h3>
<p>Get maximum association value from the data association matrix, and label the corresponding row and column as associated. If the object and the tracker is associated, the corresponding row and column is set to -1.0f.</p>
<h3 id="32-hungarian-algorithmkuhn-munkres-algorithm">3.2 Hungarian Algorithm(Kuhn-Munkres Algorithm)</h3>
<p>It's a combinatorial optimization algorithm for assignment problem. The Correlation Matrix calculated in last module as below:</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>e</mi><mi>r</mi><mo>âˆ–</mo><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>M</mi><mi>G</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>a</mi><mi>d</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>c</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>B</mi><mi>u</mi><mi>i</mi><mi>c</mi><mi>k</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>R</mi><mi>o</mi><mi>e</mi><mi>w</mi><mi>e</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>M</mi><mi>G</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>B</mi><mi>u</mi><mi>i</mi><mi>c</mi><mi>k</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>a</mi><mi>d</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>c</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold-italic">0.9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>V</mi><mi>o</mi><mi>l</mi><mi>k</mi><mi>s</mi><mi>w</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>n</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex"> \left[
\begin{matrix}
tracker\setminus{detector} &amp; MG &amp; Cadillac &amp; Buick &amp; Roewe\\
  MG &amp; 0.8 &amp; 0.6 &amp; 0 &amp; 0\\
   Buick &amp; 0 &amp; 0.3 &amp; 0.9 &amp; 0 \\
   Cadillac &amp; \boldsymbol{0.9} &amp; 0.8 &amp; 0 &amp; 0 \\
   Volkswagen &amp; 0 &amp; 0 &amp; 0.2 &amp; 0
  \end{matrix}
\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.00404em;vertical-align:-2.75004em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.254em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ£</span></span></span><span style="top:-2.2049800000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¢</span></span></span><span style="top:-2.8059800000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¢</span></span></span><span style="top:-3.4069800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¢</span></span></span><span style="top:-4.00798em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¢</span></span></span><span style="top:-5.2540000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¡</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ–</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">G</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">u</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">G</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">0</span><span class="mord mathbf">.</span><span class="mord mathbf">9</span></span></span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">6</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">3</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">u</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault">o</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">e</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.254em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¦</span></span></span><span style="top:-2.2049800000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¥</span></span></span><span style="top:-2.8059800000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¥</span></span></span><span style="top:-3.4069800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¥</span></span></span><span style="top:-4.00798em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¥</span></span></span><span style="top:-5.2540000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¤</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>The Cadillac in tracker, has a mismatch with MG in detector, the correlation coefficient larger than the Cadillac's. This happens a lot in our project, but the Hungarian Algorithm can still find a correct solution.</p>
<p>The algorithm is easier to describe if we formulate the problem using a bipartite graph. In the graph, the left shows trackers, and the right shows the new detector.</p>
<h3 id="321-step-1-valuation">3.2.1 Step 1, valuation</h3>
<p>Each tracker has a mark for it's history record, and each new detector has a mark initialized as 0. The weights between them are values in correlation matrix.<br>
<img src="../../post-images/KM-Hungarian_1.PNG" width="450" height="600" align=center /></p>
<h3 id="322-step-2-matching">3.2.2 Step 2, matching</h3>
<img src="../../post-images/KM-Hungarian_2.PNG" width="450" height="600" align=center />
<h3 id="323-step-3-conflict-management">3.2.3 Step 3, conflict management</h3>
<p>The rule of matching is that, only the weights equal or larger than tracker's mark can be matched. If conflict happens, the conflict trackers accept a penalty, and the conflict detector accept an award, the penalty and the award here set as 0.1.<br>
When the Cadillac in tracker try to match with MG in detector, because it has the highest weight - 0.9, but find the MG has already been matched with the MG in left. The MG in left try to make a concession but failed, because it doesn't have another match which weight larger than the tracker mark(0.8) can be choosen. In this condition, a conflict happens. The MG and Cadillac in tracker minus 0.1, and the MG in detector add 0.1.<br>
<img src="../../post-images/KM-Hungarian_3.PNG" width="450" height="600" align=center /></p>
<h3 id="324-back-to-step-2-with-new-marks">3.2.4 Back to step 2 with new marks</h3>
<p>As the weight between the Cadillac in tracker and the Cadillac in detector, the 0.8 meet the &quot;larger or equal tracker mark&quot; requirement, they can match now.<br>
<img src="../../post-images/KM-Hungarian_4.PNG" width="450" height="600" align=center /><br>
But for the Volkswagen, it can not solve the conflict before it's mark minus to 0 after 2 iterations. So, it can not be matched, and the following is the final solution.</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo fence="true">[</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>e</mi><mi>r</mi><mo>âˆ–</mo><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>M</mi><mi>G</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>a</mi><mi>d</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>c</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>B</mi><mi>u</mi><mi>i</mi><mi>c</mi><mi>k</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>R</mi><mi>o</mi><mi>e</mi><mi>w</mi><mi>e</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>M</mi><mi>G</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold-italic">0.8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>B</mi><mi>u</mi><mi>i</mi><mi>c</mi><mi>k</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold-italic">0.9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>a</mi><mi>d</mi><mi>i</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>c</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold-italic">0.8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>V</mi><mi>o</mi><mi>l</mi><mi>k</mi><mi>s</mi><mi>w</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>n</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex"> \left[
\begin{matrix}
tracker\setminus{detector} &amp; MG &amp; Cadillac &amp; Buick &amp; Roewe\\
  MG &amp; \boldsymbol{0.8} &amp; 0.6 &amp; 0 &amp; 0\\
   Buick &amp; 0 &amp; 0.3 &amp; \boldsymbol{0.9} &amp; 0 \\
   Cadillac &amp; 0.9 &amp; \boldsymbol{0.8} &amp; 0 &amp; 0 \\
   Volkswagen &amp; 0 &amp; 0 &amp; 0.2 &amp; 0
  \end{matrix}
\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.00404em;vertical-align:-2.75004em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.254em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ£</span></span></span><span style="top:-2.2049800000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¢</span></span></span><span style="top:-2.8059800000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¢</span></span></span><span style="top:-3.4069800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¢</span></span></span><span style="top:-4.00798em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¢</span></span></span><span style="top:-5.2540000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¡</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ–</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">G</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">u</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">G</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">0</span><span class="mord mathbf">.</span><span class="mord mathbf">8</span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">6</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">3</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">0</span><span class="mord mathbf">.</span><span class="mord mathbf">8</span></span></span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault">u</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">0</span><span class="mord mathbf">.</span><span class="mord mathbf">9</span></span></span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault">o</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord mathdefault">e</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.254em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¦</span></span></span><span style="top:-2.2049800000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¥</span></span></span><span style="top:-2.8059800000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¥</span></span></span><span style="top:-3.4069800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¥</span></span></span><span style="top:-4.00798em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¥</span></span></span><span style="top:-5.2540000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>âŽ¤</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<h3 id="33-auction-algorithm">3.3 Auction Algorithm</h3>
<p>This problem has several approaches, but the successive shortest paths (SSP) approach has been repeatedly shown to perform well for data association.<br>
Given a single source (row), one or more targets (available columns), and a nonnegative cost matrix(C0), the problem at each step becomes the classic shortest path problem as solved by Dijkstra's algorithm.<br>
<img src="../../post-images/20200927_auction algorithm.jpg" width="400" height="400" align=center /><br>
<code>Update Rule: new_profit= max_profit - 2nd-max_profit+ Îµ + pre_profit</code></p>
<pre><code class="language-cpp">// the largest weight tracker: u
max = 0;
for (i = g-&gt;cd[u]; i&lt;g-&gt;cd[u + 1]; i++) 
{
	v = g-&gt;adj[i];
	w = g-&gt;w[i];
	if ((double)w - p[v]&gt;max) 
    {
		max = (double)w - p[v];
		wmax = w;
		k = v;
	}
}
if (max == 0) 
{
	// convert to another tracker 'u'
	break;
}
// the second-largest weight tracker: u
max2 = 0;
for (i = g-&gt;cd[u]; i&lt;g-&gt;cd[u + 1]; i++) 
{
	v = g-&gt;adj[i];
	if (v != k) // k has matched with the largest weight tracker 'u'
    {
		w = g-&gt;w[i];
		if ((double)w - p[v]&gt;max2) 
        {
			max2 = (double)w - p[v];
		}
	}
}
p[k] += max - max2 + eps;
a[k] = u;
aw[k] = wmax;
res += wmax;
</code></pre>
<h1 id="4-dempstershafer-theory">4, Dempster/Shafer theory</h1>
<p>It also called evidence theory or Dempsterâ€“Shafer theory (DST), is a general framework for reasoning with uncertainty, this theory allows combining evidence from different sources and arrive at a degree of belief.</p>
<h3 id="41-build-mass-function">4.1 build mass function</h3>
<pre><code class="language-cpp">if(eSensorType == MOBILEYE)
{
    case ME_OBJECT_TYPE_PEDESTRIAN:
               gfMass[PEDESTRIAN] = 0.9f;
               gfMass[ANY] = 0.1f;
               break;
}
</code></pre>
<pre><code class="language-cpp">if(eSensorType==surroundViewCamera)
{
    case SV_OBJECT_TYPE_PEDESTRIAN:
               gfMass[PEDESTRIAN] = 0.75f;
               gfMass[ANY] = 0.25f;
               break;
    case SV_OBJECT_TYPE_BIKE:
               gfMass[MOTORBIKE] = 0.7f;
               gfMass[ANY] = 0.3f;
               break;
}
</code></pre>
<h3 id="42-normalize-mass-function">4.2 Normalize mass function</h3>
<pre><code class="language-cpp"> float CLASSIFICATION::CalNormalizationConstant(const float* gfMass_MWR, const float* gfMass_ME, const float* gfMass_SV)
 {
     float K = SUM(gfMass_MWR[PEDESTRIAN_BICYCLE] * gfMass_ME[PEDESTRIAN] * gfMass_SV[PEDESTRIAN]+...)
 }
</code></pre>
<h3 id="43-calmasscombination">4.3 CalMassCombination</h3>
<p>For each class, combine and normalize their possibility, take the &quot;PEDESTRIAN&quot; as an example.</p>
<pre><code class="language-cpp">gfMass_Combination[PEDESTRIAN] = (1.0f/K) * (gfMass_MWR[PEDESTRIAN_BICYCLE] * gfMass_ME[PEDESTRIAN] * gfMass_SV[PEDESTRIAN]
+ gfMass_MWR[PEDESTRIAN_BICYCLE] * gfMass_ME[PEDESTRIAN] * gfMass_SV[ANY]
+ gfMass_MWR[PEDESTRIAN_BICYCLE] * gfMass_ME[ANY] * gfMass_SV[PEDESTRIAN]
+ gfMass_MWR[ANY] * gfMass_ME[PEDESTRIAN] * gfMass_SV[PEDESTRIAN]
+ gfMass_MWR[ANY] * gfMass_ME[PEDESTRIAN] * gfMass_SV[ANY]
+ gfMass_MWR[ANY] * gfMass_ME[ANY] * gfMass_SV[PEDESTRIAN]);
</code></pre>
<h3 id="44-dempstershaferjudge">4.4 DempsterShaferJudge</h3>
<pre><code class="language-cpp">if((fMaxScore - fSencondScore) &gt; 0.2 &amp;&amp; gfMass_Combination[ANY] &lt; 0.5 &amp;&amp; fMaxScore &gt; gfMass_Combination[ANY])
    return (FRAME_DISCERNMENT)nMaxScoreIndex;
else
    return ANY;
</code></pre>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#1-calcrelatevalue">1, CalcRelateValue</a><br>
*
<ul>
<li><a href="#11-for-mobileye-velodyne-and-surround-view-cameras">1.1 For Mobileye, Velodyne and surround-view-cameras</a></li>
<li><a href="#12-for-mwr">1.2 For MWR</a></li>
<li><a href="#13-for-hdmap">1.3 For HDmap</a></li>
</ul>
</li>
<li><a href="#2-calculate-correlation-matrix">2, Calculate Correlation Matrix</a></li>
<li><a href="#3-getmaximumassociationvalue">3, GetMaximumAssociationValue</a><br>
*
<ul>
<li><a href="#31-nearest-neighbor-algorithm">3.1 Nearest Neighbor Algorithm</a></li>
<li><a href="#32-hungarian-algorithmkuhn-munkres-algorithm">3.2 Hungarian Algorithm(Kuhn-Munkres Algorithm)</a></li>
<li><a href="#321-step-1-valuation">3.2.1 Step 1, valuation</a></li>
<li><a href="#322-step-2-matching">3.2.2 Step 2, matching</a></li>
<li><a href="#323-step-3-conflict-management">3.2.3 Step 3, conflict management</a></li>
<li><a href="#324-back-to-step-2-with-new-marks">3.2.4 Back to step 2 with new marks</a></li>
<li><a href="#33-auction-algorithm">3.3 Auction Algorithm</a></li>
</ul>
</li>
<li><a href="#4-dempstershafer-theory">4, Dempster/Shafer theory</a><br>
*
<ul>
<li><a href="#41-build-mass-function">4.1 build mass function</a></li>
<li><a href="#42-normalize-mass-function">4.2 Normalize mass function</a></li>
<li><a href="#43-calmasscombination">4.3 CalMassCombination</a></li>
<li><a href="#44-dempstershaferjudge">4.4 DempsterShaferJudge</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">Next</div>
            <a href="https://lhf2011.github.io/post/ground-plane-segmentation/">
              <h3 class="post-title">
                Ground plane segmentation(RANSAC) and clustering(DBSCAN)
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://lhf2011.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
